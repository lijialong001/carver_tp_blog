{extend name="article/articleIndex" /}
<body style="background: url(__ADMIN__/headdata/images/self.jpeg) no-repeat center;background-size:220% 100%;position:relative">
<!--top begin-->
</div>
<!--top end-->
<article>
    {block name="mid_part"}
    <!--lbox begin-->
    <div class="lbox">
        <div class="content_box whitebg">
            <h1 class="con_tilte">{$article_info['article_title']}</h1>
            <p class="con_info"><b><span style="font-size: 20px">简介:</span> <span>{$article_info['article_desc']}</span></b></p>
            <div class="con_text">
                {$article_info['article_content']| raw}
                <p class="share"><b>转载：</b>感谢您对Carver个人博客网站平台的认可，但转载请说明文章出处“来源Carver个人博客”
                </p>
                <p><span class="diggit"><a href="javascript:void(0)" class="click_prize"
                                           click-text="{$article_info['article_id']}"><span
                        class="glyphicon glyphicon-thumbs-up"></span></a>&nbsp;&nbsp;( <span class="click_num">{$article_info['click_num']}</span> )</span>
                </p>
                <div class="nextinfo">
                    <p>上一篇：<a href="javascript:void (0)">{$pre_article}</a></p>
                    <p>下一篇：<a href="javascript:void (0)">{$next_article}</a></p>
                </div>
            </div>
        </div>
        <div class="whitebg gbook" art_id="{$article_info['article_id']}" id="article_info">
            <textarea name="publish_content" required lay-verify="required" placeholder="请先登录后发布评论..."
                      class="layui-textarea"></textarea>
            <button class="layui-btn layui-btn-radius layui-btn-normal" style="float: right;margin-top: 5px"
                    id="publish_btn">发布
            </button>
            <h2 class="htitle" style="margin-top: 30px">文章评论</h2>
            <input type="hidden" value="{$Request.session.user_name}" class="is_login">
            <ul class="comment_list">
                {empty name="comments"}
                暂时没有更多评论...
                {else /}
                {foreach $comments as $key => $value}
                <li>
                <li class="layui-timeline-item per_comment">
                    <i class="layui-icon layui-timeline-axis">&#xe63f;</i>
                    <div class="layui-timeline-content layui-text">
                        <h3 class="layui-timeline-title"><b>{$value.user_name}</b>&nbsp;<a href="javascript:void(0)"
                                                                                           class="tip_people"
                                                                                           user-info="{$value.user_id}"
                                                                                           style="color: steelblue"
                                                                                           comment-id="{$value.comment_id}">回复</a>
                        </h3>
                        <p>
                            {$value.comment_content} <span style="float: right"><b>{$value.create_time | date="Y-m-d H:i"}</b></span>
                        </p>
                        <textarea placeholder="请先登录后回复评论..." rows="3" cols="30" class="comment_click"
                                  style="display: none"></textarea>
                        <button class="layui-btn layui-btn-radius layui-btn-primary" id="publish" style="display: none">
                            点击回复
                        </button>
                    </div>
                </li>

                <br>
                {empty name="value.son"}
                <!--一级评论-->
                {foreach $value.son as $ks => $vs}

                <li class="per_comment">
                    <i class="layui-icon layui-timeline-axis">&#xe63f;</i>
                    <div class="layui-timeline-content layui-text">
                        <h3 class="layui-timeline-title"><b>{$value.user_name}</b>&nbsp;<a href="javascript:void(0)"
                                                                                           class="tip_people"
                                                                                           user-info="{$value.user_id}"
                                                                                           style="color: steelblue"
                                                                                           comment-id="{$value.comment_id}">回复</a>
                        </h3>
                        <p>
                            {$vs.comment_to_content}<span
                                style="float: right"><b>{$vs.create_time | date="Y-m-d H:i"}</b></span>
                        </p>
                        <textarea placeholder="请先登录后回复评论..." rows="3" cols="30" class="comment_click"
                                  style="display: none"></textarea>
                        <button class="layui-btn layui-btn-radius layui-btn-primary" id="publish" style="display: none">
                            点击回复
                        </button>
                    </div>
                </li>

                {/foreach}

                {else /}
                <!--存在多级评论-->
                {foreach $value.son as $k => $v}
                <li class="per_comment">
                    <i class="layui-icon layui-timeline-axis">&#xe63f;</i>
                    <div class="layui-timeline-content layui-text">
                        <h3 class="layui-timeline-title"><b>
                            {$v.user_name} @
                            {$user_all[$v.comment_to_user_id]}</b>&nbsp;&nbsp;<a href="javascript:void(0)"
                                                                                 class="tip_people"
                                                                                 user-info="{$v.comment_user_id}"
                                                                                 style="color: steelblue"
                                                                                 comment-id="{$value.comment_id}">回复</a>
                        </h3>
                        <p>
                            <br>
                            {$v.comment_to_content} <span
                                style="float: right"><b>{$v.create_time | date="Y-m-d H:i"}</b></span>
                            <br>
                        </p>
                        <textarea placeholder="请先登录后回复评论..." rows="3" cols="30" class="comment_click"
                                  style="display: none"></textarea>
                        <button class="layui-btn layui-btn-radius layui-btn-primary" id="publish" style="display: none">
                            点击回复
                        </button>
                    </div>
                </li>

                {/foreach}

                {/empty}
                </li>
                {/foreach}
                {/empty}

            </ul>
        </div>
    </div>
    <script src="__ADMIN__/headdata/js/jquery-1.8.3.min.js"></script>
    <script>
        layui.use('layer', function () {
            //发布评论
            $(document).on("click", "#publish_btn", function () {
                var isLogin = $(".is_login").val();
                if (isLogin) {
                    var publish_content = $("[name='publish_content']").val();
                    if (publish_content == '') {
                        layer.msg("品论不能为空~", {icon: -5, time: 1500});
                        return false;
                    }
                    var article_id = $("#article_info").attr("art_id");
                    $.ajax({
                        url: '/web/ArticleUser/addComment',
                        data: {article_id: article_id, comment_content: publish_content},
                        type: "post",
                        dataType: "json",
                        success: function (req) {
                            layer.msg(req['msg'], {icon: -1, time: 1500}, function () {
                                window.location.reload();
                            });
                        }
                    })
                } else {
                    layer.msg("请先登录!", {icon: 5, time: 1500});
                }
            });

            //回复评论
            $(document).on("click", ".per_comment div h3 .tip_people", function () {
                $(this).parent("h3").siblings(".comment_click").toggle();//发布的评论内容
                $(this).parent("h3").siblings("#publish").toggle();//发布评论的按钮

                var user_id = $(this).attr("user-info");//用户id
                var article_id = $("#article_info").attr("art_id");//文章id
                var comment_id = $(this).attr("comment-id");//评论id

                $(this).parent("h3").siblings("#publish").click(function () {
                    var comment_contents = $(this).siblings(".comment_click").val();//被回复的内容
                    if (comment_contents == '') {
                        layer.msg("回复的内容不能为空~", {icon: -5, time: 1500});
                        return false;
                    }
                    $.ajax({
                        url: '/web/ArticleUser/searchRepeatUser',
                        data: {
                            article_id: article_id,
                            user_id: user_id,
                            comment_content: comment_contents,
                            comment_id: comment_id
                        },
                        type: "post",
                        dataType: "json",
                        success: function (req) {
                            if (req['code'] == 1) {
                                layer.msg(req['msg'], {icon: -1, time: 1500}, function () {
                                    window.location.reload();
                                });
                            } else {
                                layer.msg(req['msg'], {icon: 5, time: 1500}, function () {
                                    window.location.reload();
                                });
                            }

                        }
                    })
                })

            })


            //点赞
            $(document).on("click", ".click_prize", function () {
                var article_id = $(this).attr("click-text");
                var keyClick=Date.parse(new Date());//当前时间戳
                var user_data=JSON.parse(window.localStorage.getItem("userInfo"));
                
                var base = new Base64();  
            	var token = base.encode(user_data['token']).replaceAll("\r\n", ""); 
            

                $.ajax({
                    url: '/web/ArticleUser/clickPrize',
                    data: {
                        article_id: article_id,
                        key_time:keyClick,
                        user_id:JSON.parse(user_data['userInfo'])['user_id'],
                        token:token,
                    },
                    type: "post",
                    dataType: "json",
                    success: function (req) {
                        if (req['code'] == 1) {
                            var oldClick = $(".click_prize").siblings(".click_num").html();//旧的点击量
                            var newClick = parseInt(oldClick) + 1;
                            $(".click_prize").siblings(".click_num").html(newClick);//新的点击量
                            layer.msg(req['msg'], {icon: -1, time: 1500});
                        } else {
                            layer.msg(req['msg'], {icon: 5, time: 1500});
                        }

                    }
                })
            })
        });
        
        


        function Base64() {  

        // private property  
        _keyStr = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";  

        // public method for encoding  
        this.encode = function (input) {  
            var output = "";  
            var chr1, chr2, chr3, enc1, enc2, enc3, enc4;  
            var i = 0;  
            input = _utf8_encode(input);  
            while (i < input.length) {  
                chr1 = input.charCodeAt(i++);  
                chr2 = input.charCodeAt(i++);  
                chr3 = input.charCodeAt(i++);  
                enc1 = chr1 >> 2;  
                enc2 = ((chr1 & 3) << 4) | (chr2 >> 4);  
                enc3 = ((chr2 & 15) << 2) | (chr3 >> 6);  
                enc4 = chr3 & 63;  
                if (isNaN(chr2)) {  
                    enc3 = enc4 = 64;  
                } else if (isNaN(chr3)) {  
                    enc4 = 64;  
                }  
                output = output +  
                _keyStr.charAt(enc1) + _keyStr.charAt(enc2) +  
                _keyStr.charAt(enc3) + _keyStr.charAt(enc4);  
            }  
            return output;  
        }  

        // public method for decoding  
        this.decode = function (input) {  
            var output = "";  
            var chr1, chr2, chr3;  
            var enc1, enc2, enc3, enc4;  
            var i = 0;  
            input = input.replace(/[^A-Za-z0-9\+\/\=]/g, "");  
            while (i < input.length) {  
                enc1 = _keyStr.indexOf(input.charAt(i++));  
                enc2 = _keyStr.indexOf(input.charAt(i++));  
                enc3 = _keyStr.indexOf(input.charAt(i++));  
                enc4 = _keyStr.indexOf(input.charAt(i++));  
                chr1 = (enc1 << 2) | (enc2 >> 4);  
                chr2 = ((enc2 & 15) << 4) | (enc3 >> 2);  
                chr3 = ((enc3 & 3) << 6) | enc4;  
                output = output + String.fromCharCode(chr1);  
                if (enc3 != 64) {  
                    output = output + String.fromCharCode(chr2);  
                }  
                if (enc4 != 64) {  
                    output = output + String.fromCharCode(chr3);  
                }  
            }  
            output = _utf8_decode(output);  
            return output;  
        }  

        // private method for UTF-8 encoding  
        _utf8_encode = function (string) {  
            string = string.replace(/\r\n/g,"\n");  
            var utftext = "";  
            for (var n = 0; n < string.length; n++) {  
                var c = string.charCodeAt(n);  
                if (c < 128) {  
                    utftext += String.fromCharCode(c);  
                } else if((c > 127) && (c < 2048)) {  
                    utftext += String.fromCharCode((c >> 6) | 192);  
                    utftext += String.fromCharCode((c & 63) | 128);  
                } else {  
                    utftext += String.fromCharCode((c >> 12) | 224);  
                    utftext += String.fromCharCode(((c >> 6) & 63) | 128);  
                    utftext += String.fromCharCode((c & 63) | 128);  
                }  

            }  
            return utftext;  
        }  

        // private method for UTF-8 decoding  
        _utf8_decode = function (utftext) {  
            var string = "";  
            var i = 0;  
            var c = c1 = c2 = 0;  
            while ( i < utftext.length ) {  
                c = utftext.charCodeAt(i);  
                if (c < 128) {  
                    string += String.fromCharCode(c);  
                    i++;  
                } else if((c > 191) && (c < 224)) {  
                    c2 = utftext.charCodeAt(i+1);  
                    string += String.fromCharCode(((c & 31) << 6) | (c2 & 63));  
                    i += 2;  
                } else {  
                    c2 = utftext.charCodeAt(i+1);  
                    c3 = utftext.charCodeAt(i+2);  
                    string += String.fromCharCode(((c & 15) << 12) | ((c2 & 63) << 6) | (c3 & 63));  
                    i += 3;  
                }  
            }  
            return string;  
        }  
    }


    </script>
    {/block}

    {block name='card'}

    {/block}

    {block name='click_part'}
    <div class="whitebg paihang">
        <h2 class="htitle"><i class="fa fa-line-chart fa-lg" style="color:red"></i></i>&nbsp;热榜排行</h2>
      <!--  <section class="topnews imgscale"><a href="info.html"><img-->
      <!--          src="__ADMIN__/headdata/images/h1.jpg"><span>php手把手教你，点击试试看-->
      <!--</span></a></section>-->
        <ul>
            {foreach $click_articles as $k => $v}
            <li><i></i><a
                    href="{:url('ArticleUser/articleDetail')}?article_id={$v['article_id']}">{$v['article_title']}</a>
            </li>
            {/foreach}
        </ul>
    </div>
    {/block}

    {block name='tag'}
    <div class="whitebg cloud">
        <h2 class="htitle"><i class="fa fa-tags fa-lg" style="color:#0099FF"></i>&nbsp;标签云
            </h2>
        <ul>
            {foreach $label as $k => $v}
            <a href="{:url('ArticleUser/searchArticleLabel')}?label={$v}">{$v}</a>
            {/foreach}

        </ul>
    </div>
    {/block}
</article>
<footer>
    <div class="box">
        <div class="endnav">
            <p><b>关于我们</b></p>
        </div>
    </div>
    <a href="#">
        <div class="top"></div>
    </a></footer>
</body>
</html>

